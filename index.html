<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CNN Explainer - TinyCNN</title>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #f5f5f5;
            overflow-x: auto;
        }

        .header {
            background: #3a3a3a;
            color: white;
            padding: 30px 40px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .header-left { display: flex; gap: 30px; max-width: 70%; }
        .title { font-size: 32px; font-weight: bold; min-width: 280px; }
        .description { font-size: 14px; color: #d0d0d0; line-height: 1.5; }
        .description strong { color: white; }

        .image-selector {
            background: white;
            padding: 20px;
            display: flex;
            gap: 15px;
            border-bottom: 2px solid #e0e0e0;
            overflow-x: auto;
        }

        .sample-image { position: relative; border: 3px solid transparent; border-radius: 4px; cursor: pointer; }
        .sample-image.active { border-color: #007bff; }
        .sample-image canvas { width: 64px; height: 64px; image-rendering: pixelated; }
        .sample-label { font-size: 11px; color: #666; position: absolute; bottom: -18px; width: 100%; text-align: center; }

        .controls { background: white; padding: 15px 20px; border-bottom: 1px solid #ddd; display: flex; gap: 10px; }

        .visualization-container { padding: 40px 20px; overflow-x: auto; }

        .network-flow {
            display: flex;
            gap: 40px;
            align-items: stretch;
            justify-content: center;
            transform-origin: top left;
        }

        .layer-column {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            min-width: 220px;
        }

        .layer-title { font-size: 14px; font-weight: bold; }
        .layer-subtitle { font-size: 11px; color: #666; }

        .feature-maps-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            max-width: 320px;
            justify-content: center;
        }

        .feature-map-item {
            background: white;
            border: 1px solid #ddd;
            padding: 5px;
            border-radius: 4px;
        }

        /* Enlarged feature maps */
        .feature-map-item canvas {
            width: 70px;
            height: 70px;
            image-rendering: pixelated;
        }

        .channel-label { font-size: 9px; color: #777; text-align: center; }

        /* >>> ARROW FIX HERE <<< */
        .arrow {
            font-size: 40px;
            color: #bbb;
            display: flex;
            align-items: center;
            justify-content: center;
            align-self: stretch;
        }

        .output-box {
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            min-width: 180px;
        }

        .output-digit { font-size: 64px; color: #007bff; }

        .prob-list { margin-top: 10px; text-align: left; font-size: 11px; }
        .prob-item { display: flex; justify-content: space-between; color: #0056b3; }
        .prob-max { color: #d32f2f; font-weight: bold; }

        .loading { padding: 60px; text-align: center; }
    </style>
</head>

<body>

<header class="header">
    <div class="header-left">
        <h1 class="title">Convolutional Neural Network Explanation</h1>
        <div class="description">
            Prepared by <strong>Maju Sumanto</strong> for Neural Computation — supervised by <strong>Professor Yuki Todo</strong>.
        </div>
    </div>
</header>

<div class="image-selector" id="imageSelector"></div>

<div class="controls">
    <button onclick="adjustZoom(0.9)">Zoom Out</button>
    <button onclick="adjustZoom(1.1)">Zoom In</button>
    <button onclick="adjustZoom('reset')">Reset</button>
</div>

<div id="content">
    <div class="loading">Loading model and sample data…</div>
</div>

<script>
let sampleData = null;
let currentSample = 0;
let zoomLevel = 1;

async function loadData() {
    const res = await fetch('sample_data.json');
    sampleData = await res.json();
    buildSelector();
    visualizeSample(0);
}

function buildSelector() {
    const selector = document.getElementById('imageSelector');
    selector.innerHTML = "";

    sampleData.forEach((s, i) => {
        const div = document.createElement("div");
        div.className = "sample-image" + (i===0?" active":"");
        div.onclick = ()=>selectSample(i);

        const c = document.createElement("canvas");
        c.width = 28; c.height = 28;
        renderCanvas(c,s.input,0);
        div.appendChild(c);

        const l=document.createElement("div");
        l.className="sample-label";
        l.textContent="Label: "+s.label;
        div.appendChild(l);

        selector.appendChild(div);
    });
}

function selectSample(i){
    currentSample=i;
    document.querySelectorAll('.sample-image').forEach((e,idx)=>e.classList.toggle('active',idx===i));
    visualizeSample(i);
}

function visualizeSample(i){
    const s=sampleData[i];
    const logits=s.activations.output[0];
    const probs=softmax(logits);
    const maxIdx=probs.indexOf(Math.max(...probs));

    const conv1=getShape(s.activations.conv1);
    const pool1=getShape(s.activations.pool1);
    const conv2=getShape(s.activations.conv2);
    const pool2=getShape(s.activations.pool2);

    const probHtml=probs.map((p,idx)=>`
        <div class="prob-item ${idx===maxIdx?'prob-max':''}">
            <span>Class ${idx}</span>
            <span>${(p*100).toFixed(2)}%</span>
        </div>
    `).join('');

    document.getElementById('content').innerHTML=`
        <div class="visualization-container">
            <div class="network-flow" style="transform:scale(${zoomLevel})">

                <div class="layer-column">
                    <div class="layer-title">Input</div>
                    <div class="layer-subtitle">(28,28,1)</div>
                    <div class="feature-maps-grid">
                        <div class="feature-map-item">
                            <canvas id="input" width="28" height="28"></canvas>
                        </div>
                    </div>
                </div>

                <div class="arrow">→</div>

                <div class="layer-column">
                    <div class="layer-title">Conv 1</div>
                    <div class="layer-subtitle">${conv1[0]} channels</div>
                    <div class="feature-maps-grid">
                        ${[...Array(conv1[0]).keys()].map(c=>`
                            <div class="feature-map-item">
                                <canvas id="conv1_${c}" width="28" height="28"></canvas>
                                <div class="channel-label">ch ${c}</div>
                            </div>`).join('')}
                    </div>
                </div>

                <div class="arrow">→</div>

                <div class="layer-column">
                    <div class="layer-title">Pool 1</div>
                    <div class="layer-subtitle">${pool1[0]} channels</div>
                    <div class="feature-maps-grid">
                        ${[...Array(pool1[0]).keys()].map(c=>`
                            <div class="feature-map-item">
                                <canvas id="pool1_${c}" width="14" height="14"></canvas>
                                <div class="channel-label">ch ${c}</div>
                            </div>`).join('')}
                    </div>
                </div>

                <div class="arrow">→</div>

                <div class="layer-column">
                    <div class="layer-title">Conv 2</div>
                    <div class="layer-subtitle">${conv2[0]} channels</div>
                    <div class="feature-maps-grid">
                        ${[...Array(conv2[0]).keys()].map(c=>`
                            <div class="feature-map-item">
                                <canvas id="conv2_${c}" width="14" height="14"></canvas>
                                <div class="channel-label">ch ${c}</div>
                            </div>`).join('')}
                    </div>
                </div>

                <div class="arrow">→</div>

                <div class="layer-column">
                    <div class="layer-title">Pool 2</div>
                    <div class="layer-subtitle">${pool2[0]} channels</div>
                    <div class="feature-maps-grid">
                        ${[...Array(pool2[0]).keys()].map(c=>`
                            <div class="feature-map-item">
                                <canvas id="pool2_${c}" width="7" height="7"></canvas>
                                <div class="channel-label">ch ${c}</div>
                            </div>`).join('')}
                    </div>
                </div>

                <div class="arrow">→</div>

                <div class="layer-column">
                    <div class="layer-title">Output</div>
                    <div class="output-box">
                        <div class="output-digit">${maxIdx}</div>
                        <div class="prob-list">${probHtml}</div>
                    </div>
                </div>
            </div>
        </div>
    `;

    renderAll(s);
}

function renderAll(s){
    renderCanvas(document.getElementById('input'),s.input,0);

    const conv1=getShape(s.activations.conv1);
    for(let c=0;c<conv1[0];c++)
        renderCanvas(document.getElementById(`conv1_${c}`),s.activations.elu1,c);

    const pool1=getShape(s.activations.pool1);
    for(let c=0;c<pool1[0];c++)
        renderCanvas(document.getElementById(`pool1_${c}`),s.activations.pool1,c);

    const conv2=getShape(s.activations.conv2);
    for(let c=0;c<conv2[0];c++)
        renderCanvas(document.getElementById(`conv2_${c}`),s.activations.elu2,c);

    const pool2=getShape(s.activations.pool2);
    for(let c=0;c<pool2[0];c++)
        renderCanvas(document.getElementById(`pool2_${c}`),s.activations.pool2,c);
}

function getShape(arr){
    return [arr.length, arr[0].length, arr[0][0].length];
}

function renderCanvas(canvas,data,channel){
    if(!canvas) return;
    const ctx=canvas.getContext('2d');
    const h=data[0].length, w=data[0][0].length;
    const img=ctx.createImageData(w,h);

    let arr=data[channel]||data[0][channel]||data;

    let min=Infinity,max=-Infinity;
    arr.forEach(r=>r.forEach(v=>{min=Math.min(min,v);max=Math.max(max,v);}));

    for(let y=0;y<h;y++)for(let x=0;x<w;x++){
        const v=(arr[y][x]-min)/(max-min+1e-8)*255;
        const i=(y*w+x)*4;
        img.data[i]=img.data[i+1]=img.data[i+2]=v;
        img.data[i+3]=255;
    }
    ctx.putImageData(img,0,0);
}

function softmax(x){
    const m=Math.max(...x);
    const e=x.map(v=>Math.exp(v-m));
    const s=e.reduce((a,b)=>a+b);
    return e.map(v=>v/s);
}

function adjustZoom(k){
    zoomLevel = k==='reset'?1:Math.max(.5,Math.min(2,zoomLevel*k));
    visualizeSample(currentSample);
}

loadData();
</script>

</body>
</html>

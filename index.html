<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TinyCNN Visualization</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #f5f5f5;
        }

        .header {
            background: #3a3a3a;
            color: white;
            padding: 30px 40px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .header-left {
            display: flex;
            gap: 30px;
            align-items: flex-start;
            max-width: 70%;
        }

        .title {
            font-size: 32px;
            font-weight: bold;
            line-height: 1.3;
            min-width: 280px;
        }

        .description {
            font-size: 14px;
            color: #d0d0d0;
            font-weight: normal;
            line-height: 1.5;
            padding-top: 2px;
        }

        .description strong {
            color: white;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .controls h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .sample-selector {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .sample-btn {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        .sample-btn:hover {
            background: #0056b3;
        }

        .sample-btn.active {
            background: #28a745;
        }

        .visualization {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .layer-container {
            margin-bottom: 40px;
            padding-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
        }

        .layer-container:last-child {
            border-bottom: none;
        }

        .layer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .layer-title {
            font-size: 22px;
            font-weight: bold;
            color: #333;
        }

        .layer-info {
            font-size: 14px;
            color: #666;
        }

        .feature-maps {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .feature-map {
            text-align: center;
        }

        .feature-map canvas {
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
            height: auto;
            image-rendering: pixelated;
        }

        .feature-map-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .prediction-box {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .prediction-label {
            font-size: 18px;
            color: #666;
            margin-bottom: 10px;
        }

        .prediction-value {
            font-size: 48px;
            font-weight: bold;
            color: #007bff;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 20px;
            border-radius: 8px;
            margin: 20px;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-left">
            <h1 class="title">Convolutional Neural Network Explanation</h1>
            <div class="description">
                This website presents an overview and explanation of Convolutional Neural Networks (CNNs), 
                prepared by <strong>Maju Sumanto</strong> to fulfill the requirements of the Neural Computation course. 
                Supervised by <strong>Professor Yuki Todo</strong>. The goal of this work is to help students and readers <strong>better understand the 
                intuition, structure, and applications of CNNs.</strong>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="controls">
            <h3>Select Sample Image</h3>
            <div class="sample-selector" id="sampleSelector">
                <!-- Buttons will be generated here -->
            </div>
        </div>

        <div id="content">
            <div class="loading">Loading model and data...</div>
        </div>
    </div>

    <script>
        let modelData = null;
        let sampleData = null;
        let currentSample = 0;

        // Load JSON files
        async function loadData() {
            try {
                const [configRes, samplesRes] = await Promise.all([
                    fetch('model_config.json'),
                    fetch('sample_data.json')
                ]);

                if (!configRes.ok || !samplesRes.ok) {
                    throw new Error('Failed to load data files. Make sure model_config.json and sample_data.json are in the same directory.');
                }

                modelData = await configRes.json();
                sampleData = await samplesRes.json();

                initializeUI();
                visualizeSample(0);
            } catch (error) {
                document.getElementById('content').innerHTML = `
                    <div class="error">
                        <strong>Error loading data:</strong> ${error.message}
                        <br><br>
                        Please ensure the following files are in the same directory:
                        <ul style="margin-top: 10px; margin-left: 20px;">
                            <li>model_config.json</li>
                            <li>sample_data.json</li>
                        </ul>
                    </div>
                `;
            }
        }

        function initializeUI() {
            const selector = document.getElementById('sampleSelector');
            selector.innerHTML = '';

            sampleData.forEach((sample, idx) => {
                const btn = document.createElement('button');
                btn.className = 'sample-btn' + (idx === 0 ? ' active' : '');
                btn.textContent = `Sample ${idx + 1} (Label: ${sample.label})`;
                btn.onclick = () => {
                    document.querySelectorAll('.sample-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    visualizeSample(idx);
                };
                selector.appendChild(btn);
            });
        }

        function visualizeSample(idx) {
            currentSample = idx;
            const sample = sampleData[idx];
            const content = document.getElementById('content');

            let html = '<div class="visualization">';

            // Input Layer
            html += createLayerHTML('Input Image', `28×28 grayscale`, 
                sample.input, 1, 28, 28);

            // Conv1 + ELU
            if (sample.activations.conv1) {
                const conv1Shape = getShape(sample.activations.conv1);
                html += createLayerHTML('Conv Layer 1 + ELU', 
                    `${conv1Shape[1]}×${conv1Shape[2]} × ${conv1Shape[0]} channels`,
                    sample.activations.elu1, conv1Shape[0], conv1Shape[1], conv1Shape[2]);
            }

            // Pool1
            if (sample.activations.pool1) {
                const pool1Shape = getShape(sample.activations.pool1);
                html += createLayerHTML('Max Pool 1', 
                    `${pool1Shape[1]}×${pool1Shape[2]} × ${pool1Shape[0]} channels`,
                    sample.activations.pool1, pool1Shape[0], pool1Shape[1], pool1Shape[2]);
            }

            // Conv2 + ELU
            if (sample.activations.conv2) {
                const conv2Shape = getShape(sample.activations.conv2);
                html += createLayerHTML('Conv Layer 2 + ELU', 
                    `${conv2Shape[1]}×${conv2Shape[2]} × ${conv2Shape[0]} channels`,
                    sample.activations.elu2, conv2Shape[0], conv2Shape[1], conv2Shape[2]);
            }

            // Pool2
            if (sample.activations.pool2) {
                const pool2Shape = getShape(sample.activations.pool2);
                html += createLayerHTML('Max Pool 2', 
                    `${pool2Shape[1]}×${pool2Shape[2]} × ${pool2Shape[0]} channels`,
                    sample.activations.pool2, pool2Shape[0], pool2Shape[1], pool2Shape[2]);
            }

            // Output
            const output = sample.activations.output[0][0];
            const prediction = output > 0 ? 1 : 0;
            const confidence = Math.abs(output);
            
            html += `
                <div class="layer-container">
                    <div class="layer-header">
                        <div class="layer-title">Output (Linear Layer)</div>
                        <div class="layer-info">Binary Classification</div>
                    </div>
                    <div class="prediction-box">
                        <div class="prediction-label">Predicted Class</div>
                        <div class="prediction-value">${prediction}</div>
                        <div class="prediction-label" style="margin-top: 10px;">
                            Confidence: ${confidence.toFixed(4)}
                        </div>
                    </div>
                </div>
            `;

            html += '</div>';
            content.innerHTML = html;

            // Render all canvases
            renderAllCanvases();
        }

        function getShape(arr) {
            // arr is [batch, channels, height, width]
            if (arr[0] && arr[0][0] && arr[0][0][0]) {
                return [arr[0].length, arr[0][0].length, arr[0][0][0].length];
            }
            // For input: [channels, height, width]
            if (arr[0] && arr[0][0]) {
                return [arr.length, arr[0].length, arr[0][0].length];
            }
            return [1, 28, 28];
        }

        function createLayerHTML(title, info, data, channels, height, width) {
            let html = `
                <div class="layer-container">
                    <div class="layer-header">
                        <div class="layer-title">${title}</div>
                        <div class="layer-info">${info}</div>
                    </div>
                    <div class="feature-maps">
            `;

            for (let c = 0; c < Math.min(channels, 16); c++) {
                html += `
                    <div class="feature-map">
                        <canvas id="canvas_${title.replace(/\s+/g, '_')}_${c}" 
                                width="${width}" height="${height}"
                                data-channel="${c}"
                                data-data="${encodeURIComponent(JSON.stringify(data))}">
                        </canvas>
                        <div class="feature-map-label">Channel ${c + 1}</div>
                    </div>
                `;
            }

            html += `
                    </div>
                </div>
            `;
            return html;
        }

        function renderAllCanvases() {
            const canvases = document.querySelectorAll('canvas');
            canvases.forEach(canvas => {
                const channel = parseInt(canvas.dataset.channel);
                const data = JSON.parse(decodeURIComponent(canvas.dataset.data));
                renderFeatureMap(canvas, data, channel);
            });
        }

        function renderFeatureMap(canvas, data, channel) {
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;

            // Extract the specific channel
            let channelData;
            if (data[0] && data[0][0] && data[0][0][0]) {
                // Format: [batch, channels, height, width]
                channelData = data[0][channel];
            } else if (data[channel]) {
                // Format: [channels, height, width]
                channelData = data[channel];
            } else {
                // Single channel input
                channelData = data;
            }

            if (!channelData) return;

            // Find min/max for normalization
            let min = Infinity, max = -Infinity;
            for (let i = 0; i < channelData.length; i++) {
                for (let j = 0; j < channelData[i].length; j++) {
                    min = Math.min(min, channelData[i][j]);
                    max = Math.max(max, channelData[i][j]);
                }
            }

            // Create image data
            const imageData = ctx.createImageData(width, height);
            for (let i = 0; i < height; i++) {
                for (let j = 0; j < width; j++) {
                    const value = channelData[i][j];
                    const normalized = (value - min) / (max - min + 1e-8);
                    const pixel = Math.floor(normalized * 255);
                    
                    const idx = (i * width + j) * 4;
                    imageData.data[idx] = pixel;     // R
                    imageData.data[idx + 1] = pixel; // G
                    imageData.data[idx + 2] = pixel; // B
                    imageData.data[idx + 3] = 255;   // A
                }
            }

            ctx.putImageData(imageData, 0, 0);
        }

        // Load data on page load
        loadData();
    </script>
</body>
</html>
